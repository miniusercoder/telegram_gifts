# C-shared Go bridge for sending Telegram Star Gifts

This module builds a small C-shared library (`libtg.so`) that exposes two C-callable functions to initialize a Telegram client and send a **Star Gift** to a user by username. It’s powered by [`github.com/amarnathcjd/gogram/telegram`](https://github.com/amarnathcjd/gogram).

---

## Features

* Minimal C API (FFI-friendly): `Init` and `SendGift`
* Resolves a `@username` → user ID and sends a **Star Gift** via Stars
* Compiles to a shared object (`.so`) with an auto-generated C header
* No updates polling, cache disabled; starts the client only for the duration of `SendGift`

---

## Build

Prereqs:

* Go 1.21+ (CGO enabled)
* A C toolchain (`gcc`/`clang`)
* Linux amd64 target (as configured in `build.sh`)

Build:

```bash
./build.sh
```

This produces:

* `libtg.so` — shared library
* `libtg.h`  — C header (generated by `-buildmode=c-shared`)

> If you don’t see `libtg.h`, ensure you are building with `-buildmode=c-shared` (already set in `build.sh`).

### Cross-compiling / other platforms

The provided script builds **Linux/amd64**:

```bash
GOOS=linux GOARCH=amd64 CGO_ENABLED=1 go build -buildmode=c-shared ...
```

Adjust `GOOS`/`GOARCH` for your target and ensure you have a working C toolchain for that platform. (On macOS, you’ll typically produce a `.dylib`, and on Windows a `.dll`.)

---

## C API

### Headers

Include the generated header:

```c
#include "libtg.h"
```

### Functions

```c
// Initializes the Telegram client.
// Returns 0 on success, negative error code on failure.
int Init(int appId, const char* appHash, const char* sessionFile);

// Sends a Star Gift to a user by @username.
// giftID: Telegram Star Gift ID (int64)
// hideName: 0 (show sender) or nonzero (hide sender name)
// Returns 0 on success, negative error code on failure.
int SendGift(const char* username, long long giftID, int hideName);
```

### Error codes

| Code | Name                      | Meaning                                     |
| ---: | ------------------------- | ------------------------------------------- |
|    0 | `Success`                 | OK                                          |
|   -1 | `ErrCreateClient`         | Failed to create client in `Init`           |
|   -2 | `ErrStartClient`          | Failed to start client (e.g. session/login) |
|   -3 | `ErrResolveUsername`      | Couldn’t resolve `@username` to a user      |
|   -4 | `ErrGetPaymentForm`       | Failed to fetch payment form for the gift   |
|   -5 | `ErrSendStars`            | Payment send failed                         |
|   -6 | `ErrClientNotInitialized` | `Init` wasn’t called or failed              |

---

## Usage overview

1. **Create a Telegram API app** to obtain `appId` and `appHash`: [https://my.telegram.org](https://my.telegram.org)
2. **Prepare a session file** path (e.g., `./session.dat`).

    * The library uses `Session: sessionFile` in the client config. The **first start** will need a valid Telegram login bound to that session. Handle the login flow **outside** of this library (e.g., using a separate tool based on the same gogram client or your own flow) and then reuse the resultant session file here.
3. **Call `Init(appId, appHash, sessionPath)`** once per process.
4. **Call `SendGift("@username", giftID, hideName)`** whenever you want to send a gift.

    * `giftID` must be a valid **Star Gift ID** (not the price). Retrieve it from your app logic or an API flow that lists available Star Gifts.
    * `hideName`: pass `1` to hide your name on the gift, `0` to show it.

> Internally, `SendGift` starts the client, performs the operation, and stops it (deferred). This simplifies use in short-lived calls but means each call establishes a client session. If you plan to send many gifts in sequence, you may wish to adapt the code to keep the client running across calls.

---

## Examples

### Python (ctypes)

```python
import ctypes
from ctypes import c_int, c_longlong, c_char_p

lib = ctypes.cdll.LoadLibrary("./libtg.so")

lib.Init.argtypes    = [c_int, c_char_p, c_char_p]
lib.Init.restype     = c_int
lib.SendGift.argtypes= [c_char_p, c_longlong, c_int]
lib.SendGift.restype = c_int

rc = lib.Init(123456, b"your_app_hash", b"./session.bin")
if rc != 0:
    raise RuntimeError(f"Init failed: {rc}")

rc = lib.SendGift(b"durov", 987654321, 1)
if rc != 0:
    raise RuntimeError(f"SendGift failed: {rc}")

print("Gift sent!")
```

---

## How it works (under the hood)

* `Init(...)` builds a `tg.Client`:

  ```go
  tg.NewClient(tg.ClientConfig{
      AppID:        int32(appId),
      AppHash:      appHashGo,
      Session:      sessionFileGo,
      LogLevel:     tg.LogInfo,
      DisableCache: true,
      NoUpdates:    true,
  })
  ```

* `SendGift(...)`:

    1. Starts the client (`client.Start()`).
    2. Resolves the username to a `*tg.UserObj`.
    3. Builds `tg.InputInvoiceStarGift` with `HideName`, peer, and `GiftID`.
    4. Calls `PaymentsGetPaymentForm(...)` and then `PaymentsSendStarsForm(...)`.
    5. Defers `client.Stop()`.

---

## Notes & caveats

* **Gift IDs**: You must supply a valid **Star Gift ID**. Listing/finding available gifts is out of scope for this library; integrate your own discovery flow.
* **Rate limits & payments**: Telegram may rate-limit or reject payments; you’ll receive `ErrSendStars` for payment failures.
* **Thread safety**: The global `client` isn’t protected for concurrent use. Avoid calling `SendGift` concurrently, or add synchronization.
* **Error handling**: Only high-level error codes are returned. For richer diagnostics, extend the API to expose messages.
* **Security**: Keep your `appHash`, `appId`, and session file secure and **do not** embed secrets in public binaries.

